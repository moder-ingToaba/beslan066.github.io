<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- <link rel="stylesheet" href="css/auth.css"> -->
    <link rel="stylesheet" href="../../css/style_tj.css">
    <link rel="stylesheet" href="../../css/moments.css">
    <link rel="stylesheet" href="../../css/moment_settings.css">
    <script src="../../js/scripts_tj.js"></script>
    <title>Лента</title>
    <style>
        :root {
            --searchedPersonBack: #CFE3E7;
            --searchedPersonX: rgba(37, 137, 159, 0.81);
        }

        .moment-settings-exceptions {
            border-width: 1px;
            padding: 4px;
        }

        .moment-settings-exception {
            background-color: var(--searchedPersonBack);
            color: var(--secGreyBlue);
            padding: 4px 6px;
            border-radius: 8px;
        }

        .moment-settings-exception-X {
            background-color: var(--searchedPersonX);
            padding: 2px 6px;
            margin-left: 4px;
            color: white;
            display: inline-block;
            border-radius: 5px;
            cursor: pointer;
        }

        .moment-settings-exceptions-container input {
            border: none;
            outline: none;
            padding: 4px;
            line-height: 1.6;
            width: 100%;
            font-size: 14px;
            margin: 3px;
        }

        .moment-settings-exceptions-filter-container {
            display: none;
        }
    </style>
</head>
<body>
    <div id="popMomentSettings" class="wide tall" style="bottom: 0;">
        <div class="moment-settings-wrapper wide tall s-flexCol">
            <div class="s-flexCol" style="flex-grow: 1; position: relative; padding-top: 18px;">
                <div class="moment-settings-header">
                    Могут смотреть
                </div>
                <div class="moment-settings-input-group">
                    <div class="moment-settings-row">
                        <input id="look-all" name="look-all" type="checkbox" checked>
                        <label for="look-all">Все</label>
                    </div>
                    <div class="moment-settings-row">
                        <input id="look-subs" name="look-subs" type="checkbox">
                        <label for="look-subs">Только подписчики</label>
                    </div>
                    <div class="moment-settings-row">
                        <input id="look-relatives" name="look-relatives" type="checkbox">
                        <label for="look-relatives">Только близкие родственники</label>
                    </div>
                    <div class="moment-settings-row">
                        <input id="look-all-except" name="look-all-except" type="checkbox">
                        <label for="look-all-except">Все, кроме</label>
                    </div>
                    <div class="moment-settings-exceptions">
                        <div class="moment-settings-exceptions-container">
                            <input type="text" placeholder="Введите имя">
                        </div>
                        <div class="moment-settings-exceptions-filter-container">
                            <div class="moment-settings-exceptions-filter">
                                <svg width="20" height="14" viewBox="0 0 20 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11.875 11.1243L1.75 11.1243" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M18.25 11.1243L15.625 11.1243" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M13.75 12.9993C14.7855 12.9993 15.625 12.1598 15.625 11.1243C15.625 10.0887 14.7855 9.24927 13.75 9.24927C12.7145 9.24927 11.875 10.0887 11.875 11.1243C11.875 12.1598 12.7145 12.9993 13.75 12.9993Z" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M5.875 2.87432L1.75 2.87427" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M18.25 2.87427L9.625 2.87432" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M7.75 4.74927C8.78553 4.74927 9.625 3.9098 9.625 2.87427C9.625 1.83873 8.78553 0.999268 7.75 0.999268C6.71447 0.999268 5.875 1.83873 5.875 2.87427C5.875 3.9098 6.71447 4.74927 7.75 4.74927Z" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="moment-settings-header">
                    Могут комментировать
                </div>
                <div class="moment-settings-input-group">
                    <div class="moment-settings-row">
                        <input id="comment-all" name="comment-all" type="checkbox" checked>
                        <label for="comment-all">Все</label>
                    </div>
                    <div class="moment-settings-row">
                        <input id="comment-subs" name="comment-subs" type="checkbox">
                        <label for="comment-subs">Только подписчики</label>
                    </div>
                    <div class="moment-settings-row">
                        <input id="comment-relatives" name="comment-relatives" type="checkbox">
                        <label for="comment-relatives">Только близкие родственники</label>
                    </div>
                    <div class="moment-settings-row">
                        <input id="comment-all-except" name="comment-all-except" type="checkbox">
                        <label for="comment-all-except">Все, кроме</label>
                    </div>
                    <div class="moment-settings-exceptions">
                        <div class="moment-settings-exceptions-container">
                            <input type="text" placeholder="Введите имя">
                        </div>
                        <div class="moment-settings-exceptions-filter-container">
                            <div class="moment-settings-exceptions-filter">
                                <svg width="20" height="14" viewBox="0 0 20 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11.875 11.1243L1.75 11.1243" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M18.25 11.1243L15.625 11.1243" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M13.75 12.9993C14.7855 12.9993 15.625 12.1598 15.625 11.1243C15.625 10.0887 14.7855 9.24927 13.75 9.24927C12.7145 9.24927 11.875 10.0887 11.875 11.1243C11.875 12.1598 12.7145 12.9993 13.75 12.9993Z" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M5.875 2.87432L1.75 2.87427" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M18.25 2.87427L9.625 2.87432" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M7.75 4.74927C8.78553 4.74927 9.625 3.9098 9.625 2.87427C9.625 1.83873 8.78553 0.999268 7.75 0.999268C6.71447 0.999268 5.875 1.83873 5.875 2.87427C5.875 3.9098 6.71447 4.74927 7.75 4.74927Z" stroke="#7A969C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="moment-settings-search-wrapper">
                    <div id="moment-settings-search" style="background-color: #fff;">
                    
                    </div>
                </div>
            </div>

            <div id="moment-settings-buttons">
                <a id="moment-settings-cancel" class="s-curPointer" onclick="momentSettingsHide(event, false);">Отмена</a>
                <a id="moment-settings-submit" class="s-curPointer" onclick="momentSettingsHide(event, true);">Принять</a>
            </div>
        </div>
    </div>


    <script src="../../js/moments.js"></script>
    <script src="../../js/moments_search_pers.js"></script>
    <script src="../../js/moments_move_persons.js"></script>
    <script src="../../js/moments_settings.js"></script>
    <script src="../../js/modals.js"></script>
    <script>
        var momsetSearchDivWrapper = j('#moment-settings-search-wrapper')
        var momsetSearchDiv = j('#moment-settings-search')
        var momsetActiveExceptions = jj('.moment-settings-exceptions')[0]

        window.onload = function() {
            jj('.moment-settings-exception-X').forEach(element => {
                element.setAttribute('onclick', 'momsetExceptionXOnClick(event)')
            });
            jj('.moment-settings-exceptions').forEach(el => {
                let inp = el.querySelector('input')
                el.addEventListener('click', function() {
                    momsetFocusOnInput(inp)
                }, true)
                inp.setAttribute('oninput', 'momsetSearchPersonOnInput(event, this)')
            })
        }

        function momsetExceptionXOnClick(event) {
            event.target.parentElement.remove()
        }

        function momsetFocusOnInput(input) {
            input.focus()
        }

        function momsetSearchPersonOnInput(event, sender) {
            // Переделать под сервер

            momsetActiveExceptions = findParentRecursive(sender, '.moment-settings-exceptions', 8)
            momsetSearchDivWrapper.style.display = null
            momsetSearchDivWrapper.style.left = '12px'
            momsetSearchDivWrapper.style.top  = (sender.getBoundingClientRect().top + 40) + 'px'
            momsetSearchDiv.innerHTML = ''
            let str = sender.value;
            if (str.length < 3) {
                return
            }
            let searchRes = searchPersons(str, personsList);
            if (searchRes.length > 0) {
                searchRes.forEach(element => {
                    momsetSearchDiv.appendChild(_apMakeFoundPerson(element, 'momsetFoundPersonOnClick(event)'));
                })
                momsetSearchDivWrapper.style.boxShadow = '0 0 1px 2px #0000003b';
            }
        }
        
        function momsetFoundPersonOnClick(e) {
            let persWrap = e.currentTarget;
            if (!persWrap.classList.contains('pers-list-wrapper')) {
                return
            }
            let Pers = {
                fio: persWrap.querySelector('.pers-list-fio').innerHTML,
                avatar: persWrap.querySelector('img').src,
                born: persWrap.querySelector('.pers-list-birthdate').innerHTML
            }

            _msMakeExceptionPerson(Pers)
            momsetClearSearch(momsetActiveExceptions.querySelector('input'));
        }

        
        function momsetClearSearch(searchInput) {
            searchInput.value = '';
            momsetHidePersons(searchInput);
            momsetSearchDiv.innerHTML = ''
        }

        
        function momsetHidePersons(searchInput) {
            if (searchInput.value.length < 3) {
                momsetSearchDivWrapper.style.display = 'none';
                momsetSearchDivWrapper.style.boxShadow = 'none';
            }
        }

        function findParentRecursive(element, querySelector_, recursionStopCount = 6) {
            // l('element:')
            // l(element)
            let res = null
            if (recursionStopCount < 1 || querySelector_ == 'body') {
                return res
            }
            let res2 = element.parentElement
            q = querySelector_.substring(1)
            switch(querySelector_[0]) {
                case '#':
                    // проверяем id элемента
                    if (res2.id == q) {
                        res = res2
                    } else {
                        res = findParentRecursive(res2, querySelector_, recursionStopCount = recursionStopCount - 1)
                    }
                    break
                case '.':
                    // проверяем classList элемента
                    if (res2.classList.contains(q)) {
                        res = res2
                    } else {
                        res = findParentRecursive(res2, querySelector_, recursionStopCount = recursionStopCount - 1)
                    }
                    break
                default:
                    // значит проверяем тип элемента
                    if (res2.tagName == querySelector_) {
                        res = res2
                    } else {
                        res = findParentRecursive(res2, querySelector_, recursionStopCount = recursionStopCount - 1)
                    }
            }
            return res
        }

        function _msMakeExceptionPerson(persObj) {
            let excWrap = momsetActiveExceptions.querySelector('.moment-settings-exceptions-container')
            
            let exc = document.createElement('div')
            exc.classList.add('moment-settings-exception')
            exc.innerHTML = persObj.fio

            let excX = document.createElement('div')
            excX.classList.add('moment-settings-exception-X')
            excX.setAttribute('onclick', 'momsetExceptionXOnClick(event)')
            excX.innerHTML = 'X'
            exc.appendChild(excX)

            excWrap.insertBefore(exc, excWrap.querySelector('input'))
        }
    </script>
</body>
</html>